"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tm = require("type-mapping");
var output_mapping_error_1 = require("../output-mapping-error");
function mapper(f, getRawValue, setRawValue) {
    return function (req, res, next) {
        var raw = getRawValue(req, res);
        var value = f(raw.name, raw.value);
        setRawValue(req, res, value);
        next();
    };
}
exports.mapper = mapper;
function responseMapper(routeDeclaration) {
    var f = (routeDeclaration.response == undefined) ?
        function () { return undefined; } :
        routeDeclaration.response;
    return function (_req, res, next) {
        var originalJson = res.json.bind(res);
        res.json = function (rawBody) {
            if (this.statusCode >= 400 && this.statusCode < 600) {
                //We are in an erroneous state, we don't validate anything for now
                return originalJson(rawBody);
            }
            var mapResult = tm.tryMapHandled(f, "response", rawBody);
            if (mapResult.success) {
                return originalJson(mapResult.value);
            }
            else {
                throw output_mapping_error_1.makeOutputMappingError({
                    message: mapResult.mappingError.message,
                    routeDeclaration: routeDeclaration,
                    response: mapResult.mappingError,
                });
            }
        };
        next();
    };
}
exports.responseMapper = responseMapper;
//# sourceMappingURL=mapper-handler.js.map